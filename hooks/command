#!/bin/bash
set -euo pipefail

go_build_in_docker() {
  go_version="$1"
  pkg="$2"
  goos="$3"
  goarch="$4"
  shift 4

  docker run \
    -v "${PWD}:/go/src/${pkg}" \
    -w "/go/src/${pkg}" \
    -e "GOOS=${goos}" -e "GOARCH=${goarch}" -e "CGO_ENABLED=0" \
    --rm "golang:${go_version}" \
    go build -v "$@"
}

build_step() {
  local label="$1"

  cat <<YAML
  - name: ":go: ${label}"
    plugins:
      - golang-build#master:
          build: ./tests/main.go
          package: github.com/buildkite/github-release
          vars:
            "main.Version": "${BUILDKITE_TAG}"
          flags: ["-s", "-w"]
          version: 1.10.2
          goos: linux
          goarch: amd64
YAML
}

if [[ "${BUILDKITE_PLUGIN_GOLANG_BUILD_DEBUG:-false}" =~ (true|on|1) ]] ; then
  echo "--- :hammer: Enabling debug mode"
  env | sort | grep BUILDKITE_PLUGIN_GOLANG_BUILD
fi

goos="${BUILDKITE_PLUGIN_GOLANG_BUILD_GOOS:-linux}"
goarch="${BUILDKITE_PLUGIN_GOLANG_BUILD_GOARCH:-amd64}"
go_version="${BUILDKITE_PLUGIN_GOLANG_BUILD_GOLANG_VERSION:-latest}"

# TODO: Support a list here
source_files=("${BUILDKITE_PLUGIN_GOLANG_BUILD_BUILD:-main.go}")

default_pkg="buildkite.com/${BUILDKITE_ORGANIZATION_SLUG}/${BUILDKITE_PIPELINE_SLUG}"
pkg="${BUILDKITE_PLUGIN_GOLANG_BUILD_PACKAGE:-$default_pkg}"

output_name=$(dirname "$(cd "$(dirname "${source_files[0]}")"; pwd)")
build_file="build/${output_name}-${goos}-${goarch}"

go_args=("-o" "$build_file" "-v" "${source_files[@]}")

rm -rf build/
mkdir -p build/

echo "+++ Building ${output_name} for ${goos}/${goarch} with golang:${go_version} :golang:"
go_build_in_docker "$go_version" "$pkg" "$goos" "$goarch" "${go_args[@]}"

echo "~~~ Uploading artifacts"
buildkite-agent artifact upload "${build_file}"
